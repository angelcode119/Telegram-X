name: Android CI Build & Send to Telegram

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew assembleRelease
      
    - name: Get APK Info
      id: apk_info
      run: |
        APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        APK_NAME=$(basename "$APK_PATH")
        echo "path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "name=$APK_NAME" >> $GITHUB_OUTPUT
        
    - name: Send APK to Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        APK_FILE="${{ steps.apk_info.outputs.path }}"
        APK_NAME="${{ steps.apk_info.outputs.name }}"
        APK_SIZE="${{ steps.apk_info.outputs.size }}"
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        BRANCH="${{ github.ref_name }}"
        
        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d parse_mode="HTML" \
          -d text="ğŸš€ <b>Build Ù…ÙˆÙÙ‚!</b>
        
ğŸ“¦ <b>APK:</b> ${APK_NAME}
ğŸ“Š <b>Ø³Ø§ÛŒØ²:</b> ${APK_SIZE}
ğŸ”§ <b>Branch:</b> ${BRANCH}
ğŸ’¬ <b>Commit:</b> ${COMMIT_MSG}
        
â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„..."
        
        # Ø§Ø±Ø³Ø§Ù„ APK
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
          -F chat_id="${TELEGRAM_CHAT_ID}" \
          -F document=@"${APK_FILE}" \
          -F caption="âœ… Telegram-X APK Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!
        
ğŸ“± Ù†ØµØ¨ Ú©Ù† Ùˆ ØªØ³Øª Ú©Ù† ğŸ‰"
        
    - name: Upload APK as Artifact (backup)
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: app/build/outputs/apk/release/*.apk
        
    - name: Notify on Failure
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d parse_mode="HTML" \
          -d text="âŒ <b>Build Ù†Ø§Ù…ÙˆÙÙ‚!</b>
        
ğŸ”§ <b>Branch:</b> ${{ github.ref_name }}
ğŸ’¬ <b>Commit:</b> ${{ github.event.head_commit.message }}
        
ğŸ”— <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§</a>"